<% content_for :styles do %>
  <script>
    $(document).ready(function(){
        $(".razorpay-payment-button").click( function(e) {
          e.preventDefault();
          var email = $("#user_email").val();
          var pwd = $("#user_password").val();

          if(!email){
            $("#pwd-error").html("");
            $("#email-error").html("<div class='text-danger' style='margin: 0px'>Enter a valid email.</div>");
          }else if(!(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/.test(email))){
            $("#pwd-error").html("");
            $("#email-error").html("<div class='text-danger' style='margin: 0px'>Invalid email.</div>");
          }else if(!pwd || pwd.length < 6 ){
            $("#email-error").html("");
            $("#pwd-error").html("<div class='text-danger' style='margin: 0px'>Enter a minimum of 6 characters.</div>");
          }else if(pwd.length > 20){
            $("#email-error").html("");
            $("#pwd-error").html("<div class='text-danger' style='margin: 0px'>Enter a maximum of 20 characters.</div>");
          }
          else {
            $.ajax({
              type: 'POST',
              contentType: "application/json; charset=utf-8",
              url: "<% ENV['DEFAULT_HOST'] %>/checkuser?email="+$("#user_email").val(),
              headers: { },
              data : JSON.stringify({
                authenticity_token: "<%= form_authenticity_token %>",
              }),
              dataType: "json",
              success: function (result) {
                if(result['email_exists'] == false){
                  $("#pwd-error").html("");
                  $("#email-error").html("");
                  $( "#new_user" ).submit();
                }else{
                  $("#pwd-error").html("");
                  $("#email-error").html("<div class='text-danger' style='margin: 0px'>Email has already been taken.</div>");
                }
              },
              error: function (){
                console.log("something wrong!");
              }
             });
          }
       });

        $(".razorpay-payment-button-2").click( function(e) {
          e.preventDefault();
          var email = $("#user_email").val();
          var pwd = $("#user_password").val();

          if(!email){
            $("#pwd-error").html("");
            $("#email-error").html("<div class='text-danger' style='margin: 0px'>Enter a valid email.</div>");
          }else if(!(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/.test(email))){
            $("#pwd-error").html("");
            $("#email-error").html("<div class='text-danger' style='margin: 0px'>Invalid email.</div>");
          }else if(!pwd || pwd.length < 6 ){
            $("#email-error").html("");
            $("#pwd-error").html("<div class='text-danger' style='margin: 0px'>Enter a minimum of 6 characters.</div>");
          }else if(pwd.length > 20){
            $("#email-error").html("");
            $("#pwd-error").html("<div class='text-danger' style='margin: 0px'>Enter a maximum of 20 characters.</div>");
          }
          else {
            $.ajax({
              type: 'POST',
              contentType: "application/json; charset=utf-8",
              url: "<% ENV['DEFAULT_HOST'] %>/checkuser?email="+$("#user_email").val(),
              headers: { },
              data : JSON.stringify({
                authenticity_token: "<%= form_authenticity_token %>",
              }),
              dataType: "json",
              success: function (result) {
                if(result['email_exists'] == false){
                  $("#pwd-error").html("");
                  $("#email-error").html("");
                  localStorage.setItem("paytm_email", email);
                  localStorage.setItem("paytm_pwd", pwd);
                  $("#paytm_email").val(email);
                  // console.log(localStorage.getItem("paytm_pwd"));
                  $(".razorpay-payment-button-2").unbind('click').click();
                }else{
                  $("#pwd-error").html("");
                  $("#email-error").html("<div class='text-danger' style='margin: 0px'>Email has already been taken.</div>");
                }
              },
              error: function (){
                console.log("something wrong!");
              }
             });
          }
       });
    });
  </script>
<% end %>
<div class="row">
  <div class="col-md-4 offset-md-4">
    <div class="card">
      <div class="card-block">
        <%= simple_form_for(resource, as: resource_name, url: registration_path(resource_name), html: {class: 'form_horizontal', role: "form", novalidate: false}) do |f| %>
          <%= f.error_notification %>
          <div class="row">
            <div class="col-md-12" >
              <div class="form-group form-group-default" >
                <%= f.input :email, required: true, autofocus: true, class: "form-control", placeholder:"example@example.com", pattern: '[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$' %>
                <div id="email-error"></div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="form-group form-group-default">
                <%= f.input :password, required: true, class: "form-control", placeholder:"#{@minimum_password_length} characters minimum", minlength: 6, maxlength: 20 %>
                <div id="pwd-error"></div>
              </div>
              <br/>
            </div>
          </div>
          <form action="/users" method="POST">
            <!-- Note that the amount is in paise = 50 INR -->
            <script
                src="https://checkout.razorpay.com/v1/checkout.js"
                data-key="<%= ENV['RAZORPAY_ID'] %>"
                data-amount="39900"
                data-buttontext="Buy with RazorPay (₹399)"
                data-name="Calm India"
                data-description="A 4 WEEK COURSE ON BUILDING MENTAL RESILIENCE, TAILORED FOR INDIA."
                data-image=""
                data-prefill.name=""
                data-prefill.email=""
                data-theme.color="#F37254"
            ></script>
            <input type="hidden" value="Hidden Element" name="hidden">
          </form>
        <% end %>
        <strong>OR</strong>
        <br>
        <%= form_tag paytm_payment_path, method: :post, remote: false, :style => "" do %>
            <input type="hidden" id="paytm_email" name="paytm_email">
            <button class="razorpay-payment-button-2">Buy with PayTM (₹399)</button>
        <% end %>
      </div>
    </div>
    <%= render "devise/shared/links" %>
  </div>
</div>
